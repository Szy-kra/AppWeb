@model AppWeb.Application.DataTransferObject.CottageDto

@{
    ViewData["Title"] = "Dodaj Domek";
}

<h1 class="text-sun">Dodaj swój Domek do naszej społeczności</h1>
<hr class="border-success" />

<div class="container-fluid p-0">
    <form asp-action="Create" enctype="multipart/form-data" method="post">

        @* Wyświetlanie błędów walidacji (np. z DtoValidator) *@
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="row g-4">
            @* LEWA KOLUMNA: Dane tekstowe i Adres *@
            <div class="col-md-6 d-flex flex-column gap-3">

                <div class="form-group">
                    <label asp-for="Name" class="form-label fw-bold">Nazwa Domku</label>
                    <input asp-for="Name" class="form-control shadow-sm" placeholder="np. Słoneczna Polana" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Description" class="form-label fw-bold">Krótki opis (na listę)</label>
                    <input asp-for="Description" class="form-control shadow-sm" placeholder="Krótka zachęta dla turystów" />
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MaxPersons" class="form-label fw-bold">Max osób</label>
                            <input asp-for="MaxPersons" type="number" class="form-control shadow-sm" />
                            <span asp-validation-for="MaxPersons" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Price" class="form-label fw-bold">Cena za dobę [zł]</label>
                            <input asp-for="Price" type="number" step="0.01" class="form-control shadow-sm" />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Street" class="form-label fw-bold">Ulica / Adres</label>
                    <input asp-for="Street" class="form-control shadow-sm" />
                    <span asp-validation-for="Street" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="City" class="form-label fw-bold">Miasto</label>
                            <input asp-for="City" class="form-control shadow-sm" />
                            <span asp-validation-for="City" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="PostalCode" class="form-label fw-bold">Kod pocztowy</label>
                            <input asp-for="PostalCode" class="form-control shadow-sm" placeholder="00-000" />
                            <span asp-validation-for="PostalCode" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            @* PRAWA KOLUMNA: Siatka zdjęć i Długi opis *@
            <div class="col-md-6 d-flex flex-column">

                <label class="form-label fw-bold">Zdjęcia obiektu (max 6)</label>
                <div class="row g-2 mb-3">
                    @for (int i = 1; i <= 6; i++)
                    {
                        <div class="col-4">
                            <div class="card bg-dark text-white border-secondary h-100 position-relative shadow-sm"
                                 style="border-style: dashed; border-width: 2px; min-height: 120px;">

                                <label for="file-@i" class="card-body d-flex flex-column align-items-center justify-content-center p-0 text-center"
                                       style="cursor: pointer;">

                                    <div id="content-@i">
                                        <span class="small d-block">FOTO @i</span>
                                        <i class="bi bi-plus-circle opacity-50"></i>
                                    </div>

                                    <img id="preview-@i" src="#" alt="Podgląd"
                                         style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; border-radius: 4px;" />

                                    <input type="file" name="ImageFiles" id="file-@i" class="form-control d-none"
                                           accept="image/*" onchange="previewImage(this, @i)" />
                                </label>
                            </div>
                        </div>
                    }
                </div>

                <div class="form-group flex-grow-1 d-flex flex-column">
                    <label asp-for="About" class="form-label fw-bold">Szczegółowy opis domku</label>
                    <textarea asp-for="About" class="form-control shadow-sm flex-grow-1"
                              style="min-height: 150px; resize: none;"
                              placeholder="Opisz wyposażenie, atrakcje i okolicę..."></textarea>
                    <span asp-validation-for="About" class="text-danger"></span>
                </div>
            </div>
        </div>

        @* PRZYCISK ZAPISU *@
        <div class="row mt-5">
            <div class="col-md-4">
                <button type="submit" class="btn btn-success w-100 fw-bold py-3 shadow">
                    ZAPISZ I PUBLIKUJ DOMEK
                </button>
            </div>
            <div class="col-md-2">
                <a asp-action="IndexList" class="btn btn-outline-secondary w-100 py-3">Anuluj</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function previewImage(input, index) {
            const preview = document.getElementById('preview-' + index);
            const content = document.getElementById('content-' + index);
            const container = input.closest('.card');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (content) content.style.display = 'none';

                    // Usuwanie starego przycisku X
                    let oldBtn = container.querySelector('.action-btn-remove');
                    if (oldBtn) oldBtn.remove();

                    // Tworzenie nowego przycisku X
                    const btn = document.createElement('div');
                    btn.innerHTML = '×';
                    btn.className = 'action-btn-remove';
                    btn.onclick = function (event) {
                        event.preventDefault();
                        event.stopPropagation();
                        input.value = "";
                        preview.src = "#";
                        preview.style.display = 'none';
                        if (content) content.style.display = 'block';
                        this.remove();
                    };
                    container.appendChild(btn);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
}